#!/bin/bash
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}" )" && pwd )"
INFO=$DIR/../../util/info
ERROR=$DIR/../../util/error

if [ "$#" -ne 4 ]; then
	$ERROR "CROSS-GCC" "usage: $0 <absolute prefix> <gcc-version> <binutils-version> <target>"
	$ERROR "CROSS-GCC" "only $# arguments given"
	exit 1;
fi

GCC_DIR=$1
GCC_URL=https://ftp.gnu.org/gnu/gcc/gcc-$2/gcc-$2.tar.gz
BINUTILS_URL=https://ftp.gnu.org/gnu/binutils/binutils-$3.tar.gz
GCC_TARGET=$4

$INFO "MAKE" "downloading gcc"
mkdir -p $GCC_DIR/gcc
wget -c -q -O $GCC_DIR/gcc.tar.gz $GCC_URL
$INFO "MAKE" "downloading binutils"
mkdir -p $GCC_DIR/binutils
wget -c -q -O $GCC_DIR/binutils.tar.gz $BINUTILS_URL
$INFO "MAKE" "preparing gcc"
tar xzf $GCC_DIR/gcc.tar.gz --strip-components=1 -C $GCC_DIR/gcc
tar xzf $GCC_DIR/binutils.tar.gz --strip-components=1 -C $GCC_DIR/binutils
bash -c "cd $GCC_DIR/gcc; ./contrib/download_prerequisites" 2>&1 /dev/null
mkdir -p $GCC_DIR/binutils-build
$INFO "MAKE" "building binutils"
cd $GCC_DIR/binutils-build;
../binutils/configure --quiet --target=$GCC_TARGET --prefix="$GCC_DIR" --with-sysroot --disable-nls --disable-werror;
make -s -j4;
make install -s;
make clean -s
$INFO "MAKE" "building gcc"
mkdir -p $GCC_DIR/gcc-build
cd $GCC_DIR/gcc-build;
../gcc/configure --quiet --target=$GCC_TARGET --prefix="$GCC_DIR" --disable-nls --enable-languages=c --without-headers;
make -j4 all-gcc -s;
make -j4 all-target-libgcc -s;
make install-gcc -s;
make install-target-libgcc -s;
make clean -s
